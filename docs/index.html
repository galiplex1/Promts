<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Generator v3.0 - SDXL</title>
    <meta name="description" content="Generador de prompts para SDXL con votaci√≥n inteligente">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="manifest" href="manifest.json">
    <style>
        /* === CSS VARIABLES & THEMES === */
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: #1c1c32;
            --text-primary: #e0e0ff;
            --text-secondary: #a0a0cc;
            --text-muted: #666699;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --accent-secondary: #6c5ce7;
            --accent-tertiary: #00cec9;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --border: #2d2d4a;
            --shadow: rgba(0,0,0,0.4);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: 0.3s ease;
            --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-mono: 'Cascadia Code', 'Fira Code', monospace;
        }

        [data-theme="light"] {
            --bg-primary: #f5f5ff;
            --bg-secondary: #e8e8f5;
            --bg-tertiary: #ddddf0;
            --bg-card: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #4a4a6a;
            --text-muted: #8888aa;
            --accent: #e94560;
            --accent-hover: #d63031;
            --border: #ccccdd;
            --shadow: rgba(0,0,0,0.1);
        }

        /* === RESET + BASE === */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* === SCROLLBAR === */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-hover); }

        /* === LAYOUT === */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === HEADER === */
        .header {
            text-align: center;
            padding: 30px 20px 20px;
            position: relative;
        }

        .header h1 {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .header .version {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .icon-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* === MAIN GRID === */
        .main-grid {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .header-controls { position: static; justify-content: center; margin-top: 10px; }
        }

        /* === PANELS === */
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
        }

        .panel:hover { border-color: var(--accent); }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title span { font-size: 1.2rem; }

        /* === FORM ELEMENTS === */
        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 0.82rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: var(--font);
            transition: var(--transition);
            appearance: auto;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.15);
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent);
            cursor: pointer;
        }

        /* Checkbox + Toggle */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
        }

        .toggle-row label {
            margin: 0;
            text-transform: none;
            font-size: 0.88rem;
            color: var(--text-primary);
        }

        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 24px;
            transition: var(--transition);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle input:checked + .toggle-slider {
            background: var(--accent);
            border-color: var(--accent);
        }

        .toggle input:checked + .toggle-slider::before {
            transform: translateX(20px);
            background: white;
        }

        /* === BUTTONS === */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: var(--font);
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: white;
            width: 100%;
            justify-content: center;
            font-size: 1rem;
            padding: 14px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-accent { background: var(--accent-tertiary); color: white; }

        .btn-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        /* === LEVEL SELECTOR === */
        .level-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
            margin-top: 5px;
        }

        .level-btn {
            padding: 8px 4px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            text-align: center;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .level-btn:hover { border-color: var(--accent); color: var(--accent); }
        .level-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* === RESULTS === */
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .prompt-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: var(--transition);
        }

        .prompt-card:hover { border-color: var(--accent-secondary); }

        .prompt-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .prompt-number {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .token-badge {
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .token-ok { background: rgba(0, 184, 148, 0.2); color: var(--success); }
        .token-warning { background: rgba(253, 203, 110, 0.2); color: var(--warning); }
        .token-over { background: rgba(214, 48, 49, 0.2); color: var(--danger); }
        .token-critical { background: rgba(214, 48, 49, 0.4); color: var(--danger); font-weight: 800; }

        .prompt-card-body { padding: 16px; }

        .prompt-section {
            margin-bottom: 12px;
        }

        .prompt-section-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .prompt-text {
            font-family: var(--font-mono);
            font-size: 0.82rem;
            line-height: 1.7;
            color: var(--text-primary);
            background: var(--bg-primary);
            padding: 12px;
            border-radius: var(--radius-sm);
            word-break: break-word;
            position: relative;
        }

        .negative-text {
            color: var(--danger);
            background: rgba(214, 48, 49, 0.05);
        }

        .prompt-card-actions {
            display: flex;
            gap: 6px;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .vote-btn {
            padding: 6px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .vote-btn:hover { transform: scale(1.05); }
        .vote-btn.vote-up:hover { border-color: var(--success); color: var(--success); background: rgba(0,184,148,0.1); }
        .vote-btn.vote-down:hover { border-color: var(--danger); color: var(--danger); background: rgba(214,48,49,0.1); }

        .copy-btn {
            padding: 6px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
            color: var(--text-secondary);
            margin-left: auto;
        }

        .copy-btn:hover { border-color: var(--accent-secondary); color: var(--accent-secondary); }

        /* === SETTINGS === */
        .prompt-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 6px;
            margin-top: 10px;
        }

        .setting-chip {
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* === SIDEBAR SECTIONS === */
        .sidebar-section {
            border-top: 1px solid var(--border);
            padding-top: 14px;
            margin-top: 14px;
        }

        .sidebar-section:first-child {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 4px 0;
            user-select: none;
        }

        .collapsible-header .arrow {
            transition: var(--transition);
            font-size: 0.8rem;
        }

        .collapsible-header.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .collapsible-content.hidden {
            max-height: 0;
        }

        /* === CONFLICT WARNING === */
        .conflict-warning {
            background: rgba(253, 203, 110, 0.1);
            border: 1px solid var(--warning);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            margin: 10px 0;
            font-size: 0.82rem;
            display: none;
        }

        .conflict-warning.visible { display: block; }

        .conflict-item {
            color: var(--warning);
            margin: 4px 0;
        }

        .conflict-item.info { color: var(--accent-tertiary); }

        /* === SUGGESTIONS === */
        .suggestions-panel {
            background: rgba(108, 92, 231, 0.1);
            border: 1px solid var(--accent-secondary);
            border-radius: var(--radius-sm);
            padding: 10px 14px;
            margin: 10px 0;
            font-size: 0.82rem;
        }

        .suggestions-panel h4 {
            color: var(--accent-secondary);
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .suggestion-text { color: var(--text-secondary); }

        /* === PRESETS === */
        .preset-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .preset-list {
            margin-top: 8px;
        }

        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin: 4px 0;
            font-size: 0.82rem;
        }

        .preset-item span { color: var(--text-primary); cursor: pointer; flex: 1; }
        .preset-item span:hover { color: var(--accent); }
        .preset-delete { color: var(--danger); cursor: pointer; margin-left: 8px; }

        /* === HISTORY PANEL === */
        .history-panel, .stats-panel, .export-panel {
            margin-top: 20px;
        }

        .history-item {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin: 6px 0;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item:hover { color: var(--accent); border-left: 3px solid var(--accent); }

        .history-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 3px;
            font-family: var(--font);
        }

        /* === STATS === */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.72rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .preference-list {
            margin-top: 10px;
        }

        .pref-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border);
        }

        .pref-item .element { color: var(--text-secondary); flex: 1; overflow: hidden; text-overflow: ellipsis; }
        .pref-item .score { color: var(--success); font-weight: 600; min-width: 40px; text-align: right; }
        .pref-item .score.negative { color: var(--danger); }

        /* === EXPORT PANEL === */
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 6px;
        }

        /* === KEYBOARD SHORTCUTS === */
        .shortcuts-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .shortcuts-modal.visible { display: flex; }

        .shortcuts-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .shortcut-key {
            background: var(--bg-tertiary);
            padding: 3px 10px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.82rem;
            color: var(--accent);
        }

        /* === TABS === */
        .tab-bar {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: var(--transition);
        }

        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* === TOAST === */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
        }

        .toast.visible { transform: translateY(0); opacity: 1; }

        /* === RESPONSIVE === */
        @media (max-width: 600px) {
            .app-container { padding: 10px; }
            .header h1 { font-size: 1.5rem; }
            .level-selector { grid-template-columns: repeat(3, 1fr); }
            .stat-grid { grid-template-columns: 1fr; }
            .prompt-card-actions { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <h1>Prompt Generator</h1>
            <div class="version">v3.0 SDXL Full Feature Edition</div>
            <div class="header-controls">
                <button class="icon-btn" onclick="toggleTheme()" title="Cambiar tema">üåì</button>
                <button class="icon-btn" onclick="showShortcuts()" title="Atajos de teclado">‚å®Ô∏è</button>
                <button class="icon-btn" onclick="togglePanel('stats-panel')" title="Estad√≠sticas">üìä</button>
                <button class="icon-btn" onclick="togglePanel('history-panel')" title="Historial">üìú</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- === SIDEBAR === -->
            <div class="sidebar">
                <div class="panel">
                    <!-- LEVEL -->
                    <div class="sidebar-section">
                        <div class="form-group">
                            <label>Nivel de contenido</label>
                            <div class="level-selector">
                                <button class="level-btn active" onclick="setLevel(0)">0 Base</button>
                                <button class="level-btn" onclick="setLevel(1)">1 Casual</button>
                                <button class="level-btn" onclick="setLevel(2)">2 Suger.</button>
                                <button class="level-btn" onclick="setLevel(3)">3 Provoc.</button>
                                <button class="level-btn" onclick="setLevel(4)">4 Sensual</button>
                                <button class="level-btn" onclick="setLevel(5)">5 Expl√≠c.</button>
                            </div>
                        </div>
                    </div>

                    <!-- PERSON STYLE -->
                    <div class="sidebar-section">
                        <div class="form-group">
                            <label>Estilo de persona</label>
                            <select id="personStyle" onchange="onSettingsChange()">
                                <option value="normal">Normal</option>
                                <option value="futbolera">Futbolera/Atl√©tica</option>
                                <option value="alternativa">Alternativa/Punk</option>
                                <option value="gotica">G√≥tica</option>
                                <option value="pija">Pija/Elegante</option>
                                <option value="hipster">Hipster/Bohemia</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Tama√±o de pechos</label>
                            <select id="breastSize" onchange="onSettingsChange()">
                                <option value="small">Peque√±os (A)</option>
                                <option value="medium" selected>Medianos (B)</option>
                                <option value="large">Grandes (C)</option>
                                <option value="huge">Enormes (D)</option>
                            </select>
                        </div>
                    </div>

                    <!-- APPEARANCE -->
                    <div class="sidebar-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="panel-title"><span>üë§</span> Apariencia</div>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="form-group">
                                <label>Edad: <span id="ageValue">22</span></label>
                                <input type="range" id="ageSlider" min="18" max="35" value="22" oninput="document.getElementById('ageValue').textContent = this.value; onSettingsChange();">
                            </div>

                            <div class="form-group">
                                <label>Etnia</label>
                                <select id="ethnicity" onchange="onSettingsChange()">
                                    <option value="default">Por defecto</option>
                                    <option value="european">Europea</option>
                                    <option value="latina">Latina</option>
                                    <option value="asian">Asi√°tica</option>
                                    <option value="african">Africana</option>
                                    <option value="middle_eastern">Medio Oriente</option>
                                    <option value="nordic">N√≥rdica</option>
                                    <option value="mixed">Mestiza</option>
                                    <option value="indian">India</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Color de ojos</label>
                                <select id="eyeColor" onchange="onSettingsChange()">
                                    <option value="green">Verdes</option>
                                    <option value="blue">Azules</option>
                                    <option value="brown">Marrones</option>
                                    <option value="hazel">Avellana</option>
                                    <option value="amber">√Åmbar</option>
                                    <option value="grey">Grises</option>
                                    <option value="light_blue">Azul claro</option>
                                    <option value="dark_brown">Marr√≥n oscuro</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- HAIR -->
                    <div class="sidebar-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="panel-title"><span>üíá</span> Pelo</div>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="form-group">
                                <label>Estilo de pelo</label>
                                <select id="hairStyle" onchange="onSettingsChange()">
                                    <option value="auto">üé≤ Autom√°tico (seg√∫n estilo)</option>
                                    <option value="long_straight">Largo liso</option>
                                    <option value="long_waves">Largo ondulado</option>
                                    <option value="long_curls">Largo rizado</option>
                                    <option value="long_braids">Trenzas largas</option>
                                    <option value="shoulder">Media melena</option>
                                    <option value="short_bob">Bob corto</option>
                                    <option value="pixie">Pixie</option>
                                    <option value="ponytail">Coleta alta</option>
                                    <option value="bun">Mo√±o</option>
                                    <option value="messy_bun">Mo√±o desordenado</option>
                                    <option value="half_up">Semi-recogido</option>
                                    <option value="curtains">Cortina/Flequillo</option>
                                    <option value="thick_mane">Melena voluminosa</option>
                                    <option value="tousled">Despeinado sexy</option>
                                    <option value="sleek">Liso brillante</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Color de pelo</label>
                                <select id="hairColor" onchange="onSettingsChange()">
                                    <option value="auto">üé≤ Autom√°tico (seg√∫n estilo)</option>
                                    <option value="blonde">Rubio</option>
                                    <option value="dark_blonde">Rubio oscuro</option>
                                    <option value="brunette">Casta√±o oscuro</option>
                                    <option value="light_brown">Casta√±o claro</option>
                                    <option value="black">Negro</option>
                                    <option value="red">Pelirrojo</option>
                                    <option value="auburn">Caoba</option>
                                    <option value="strawberry_blonde">Rubio fresa</option>
                                    <option value="ombre">Ombr√©</option>
                                    <option value="balayage">Balayage</option>
                                    <option value="platinum">Platino</option>
                                    <option value="rose_gold">Oro rosa</option>
                                    <option value="ash_brown">Casta√±o ceniza</option>
                                    <option value="chestnut">Casta√±o rojizo</option>
                                    <option value="burgundy">Borgo√±a</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- CLASSIC CONTROLS -->
                    <div class="sidebar-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="panel-title"><span>‚öôÔ∏è</span> Controles</div>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="toggle-row">
                                <label>Con ropa</label>
                                <div class="toggle">
                                    <input type="checkbox" id="clothed" checked onchange="onSettingsChange()">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>

                            <div class="toggle-row">
                                <label>Mojada</label>
                                <div class="toggle">
                                    <input type="checkbox" id="wet" onchange="onSettingsChange()">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>

                            <div class="toggle-row">
                                <label>Modo compacto</label>
                                <div class="toggle">
                                    <input type="checkbox" id="compactMode" onchange="onSettingsChange()">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>

                            <div class="toggle-row">
                                <label>Pesos (emphasis)</label>
                                <div class="toggle">
                                    <input type="checkbox" id="emphasisMode" onchange="onSettingsChange()">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top:10px">
                                <label>Ropa espec√≠fica</label>
                                <select id="clothing" onchange="onSettingsChange()">
                                    <option value="random">üé≤ Random</option>
                                    <option value="lingerie">Lencer√≠a</option>
                                    <option value="lingerie_sheer">Lencer√≠a transparente</option>
                                    <option value="lingerie_lace">Encaje franc√©s</option>
                                    <option value="bikini">Bikini</option>
                                    <option value="bikini_micro">Micro bikini</option>
                                    <option value="towel">Toalla</option>
                                    <option value="towel_barely">Toalla (apenas)</option>
                                    <option value="bedsheet">S√°bana</option>
                                    <option value="robe">Bata</option>
                                    <option value="nightgown">Camis√≥n</option>
                                    <option value="corset">Cors√©</option>
                                    <option value="stockings_garter">Medias + liguero</option>
                                    <option value="harness_lingerie">Arn√©s</option>
                                    <option value="bodysuit_sheer">Body transparente</option>
                                    <option value="none_nude">Desnudo completo</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ADVANCED -->
                    <div class="sidebar-section">
                        <div class="collapsible-header collapsed" onclick="toggleCollapsible(this)">
                            <div class="panel-title"><span>üéØ</span> Avanzado</div>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content hidden">
                            <div class="form-group">
                                <label>Expresi√≥n facial</label>
                                <select id="facialExpression" onchange="onSettingsChange()">
                                    <option value="random">üé≤ Random</option>
                                    <option value="seductive_gaze">Mirada seductora</option>
                                    <option value="lustful_eyes">Ojos lujuriosos</option>
                                    <option value="playful_smile">Sonrisa p√≠cara</option>
                                    <option value="biting_lip">Mordiendo labio</option>
                                    <option value="mouth_open">Boca entreabierta</option>
                                    <option value="intense_contact">Contacto intenso</option>
                                    <option value="bedroom_eyes">Ojos de dormitorio</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>√Ångulo de c√°mara</label>
                                <select id="cameraAngle" onchange="onSettingsChange()">
                                    <option value="random">üé≤ Random</option>
                                    <option value="eye_level">Nivel de ojos</option>
                                    <option value="low_angle">√Ångulo bajo</option>
                                    <option value="high_angle">√Ångulo alto</option>
                                    <option value="over_shoulder">Sobre el hombro</option>
                                    <option value="from_behind">Desde atr√°s</option>
                                    <option value="side_profile">Perfil lateral</option>
                                    <option value="close_up">Primer plano</option>
                                    <option value="full_body">Cuerpo completo</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Ubicaci√≥n</label>
                                <select id="location" onchange="onSettingsChange()">
                                    <option value="random">üé≤ Random</option>
                                    <option value="bedroom">Dormitorio</option>
                                    <option value="bathroom">Ba√±o</option>
                                    <option value="mirror">Espejo</option>
                                    <option value="luxury_bedroom">Dormitorio lujoso</option>
                                    <option value="hotel_room">Hotel boutique</option>
                                    <option value="jacuzzi">Jacuzzi</option>
                                    <option value="sauna">Sauna</option>
                                    <option value="poolside">Piscina</option>
                                    <option value="beach_cabana">Caba√±a playa</option>
                                    <option value="yacht">Yate</option>
                                    <option value="villa">Villa</option>
                                    <option value="rooftop">Azotea</option>
                                    <option value="spa">Spa</option>
                                    <option value="resort">Resort</option>
                                    <option value="beach_house">Casa playa</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Escenario</label>
                                <select id="scenario" onchange="onSettingsChange()">
                                    <option value="random">üé≤ Random</option>
                                    <option value="morning_after">Ma√±ana siguiente</option>
                                    <option value="getting_ready">Arregl√°ndose</option>
                                    <option value="after_shower">Tras la ducha</option>
                                    <option value="photoshoot">Sesi√≥n de fotos</option>
                                    <option value="boudoir">Boudoir</option>
                                    <option value="intimate_selfie">Selfie √≠ntimo</option>
                                    <option value="getting_undressed">Desvisti√©ndose</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- CONFLICT WARNING -->
                    <div id="conflictWarning" class="conflict-warning"></div>

                    <!-- SUGGESTIONS -->
                    <div id="suggestionsPanel" class="suggestions-panel" style="display:none">
                        <h4>üí° Sugerencias para este estilo</h4>
                        <div id="suggestionsText" class="suggestion-text"></div>
                    </div>

                    <!-- PRESETS -->
                    <div class="sidebar-section">
                        <div class="collapsible-header collapsed" onclick="toggleCollapsible(this)">
                            <div class="panel-title"><span>üíæ</span> Presets</div>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content hidden">
                            <div class="preset-actions">
                                <input type="text" id="presetName" placeholder="Nombre del preset..." style="flex:1">
                                <button class="btn btn-sm btn-secondary" onclick="saveCurrentPreset()">Guardar</button>
                            </div>
                            <div id="presetList" class="preset-list"></div>
                        </div>
                    </div>

                    <!-- GENERATE BUTTONS -->
                    <div class="sidebar-section">
                        <div class="form-group">
                            <label>Cantidad de prompts</label>
                            <select id="batchCount">
                                <option value="1">1 prompt</option>
                                <option value="3" selected>3 prompts</option>
                                <option value="5">5 prompts</option>
                                <option value="10">10 prompts</option>
                            </select>
                        </div>

                        <button class="btn btn-primary" onclick="generatePrompts()" id="generateBtn">
                            üé≤ Generar Prompts
                        </button>

                        <div class="btn-group" style="margin-top:10px">
                            <button class="btn btn-sm btn-accent" onclick="generateInspiration()" title="Genera con todo random">üé∞ Inspiraci√≥n</button>
                            <button class="btn btn-sm btn-secondary" onclick="generateVariations()" title="Variaciones del √∫ltimo prompt">üîÑ Variaciones</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === MAIN CONTENT === -->
            <div class="main-content">
                <!-- TAB BAR -->
                <div class="tab-bar">
                    <div class="tab active" onclick="switchTab('results')">Resultados</div>
                    <div class="tab" onclick="switchTab('history')">Historial</div>
                    <div class="tab" onclick="switchTab('stats')">Estad√≠sticas</div>
                    <div class="tab" onclick="switchTab('export')">Exportar</div>
                </div>

                <!-- RESULTS TAB -->
                <div id="tab-results" class="tab-content active">
                    <div id="resultsContainer" class="results-container">
                        <div class="panel" style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üé®</div>
                            <div style="color: var(--text-muted); font-size: 1rem;">
                                Pulsa <strong style="color:var(--accent)">Generar Prompts</strong> o <strong style="color:var(--text-secondary)">Ctrl+Enter</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HISTORY TAB -->
                <div id="tab-history" class="tab-content">
                    <div class="panel">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <div class="panel-title"><span>üìú</span> Historial</div>
                            <button class="btn btn-sm btn-danger" onclick="clearHistory()">Limpiar</button>
                        </div>
                        <div id="historyList"></div>
                    </div>
                </div>

                <!-- STATS TAB -->
                <div id="tab-stats" class="tab-content">
                    <div class="panel">
                        <div class="panel-title"><span>üìä</span> Estad√≠sticas de Votos</div>
                        <div id="statsContent">
                            <div class="stat-grid" id="statGrid"></div>
                            <h4 style="margin-top:20px; color:var(--success)">Top Preferencias</h4>
                            <div id="topPreferences" class="preference-list"></div>
                            <h4 style="margin-top:15px; color:var(--danger)">M√°s Evitados</h4>
                            <div id="topAvoided" class="preference-list"></div>
                        </div>
                    </div>
                </div>

                <!-- EXPORT TAB -->
                <div id="tab-export" class="tab-content">
                    <div class="panel">
                        <div class="panel-title"><span>üì¶</span> Exportar Prompts</div>
                        <p style="color:var(--text-muted); margin-bottom:15px; font-size:0.85rem;">Exporta los prompts generados en diferentes formatos</p>
                        <div class="export-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="exportAs('json')">JSON</button>
                            <button class="btn btn-sm btn-secondary" onclick="exportAs('csv')">CSV</button>
                            <button class="btn btn-sm btn-secondary" onclick="exportAs('txt')">TXT</button>
                            <button class="btn btn-sm btn-secondary" onclick="exportAs('a1111')">A1111</button>
                            <button class="btn btn-sm btn-secondary" onclick="exportAs('comfyui')">ComfyUI</button>
                        </div>
                        <div id="exportPreview" style="margin-top:15px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <!-- SHORTCUTS MODAL -->
    <div id="shortcutsModal" class="shortcuts-modal" onclick="if(event.target===this)hideShortcuts()">
        <div class="shortcuts-content">
            <h3 style="color:var(--accent); margin-bottom:15px;">‚å®Ô∏è Atajos de Teclado</h3>
            <div class="shortcut-row"><span>Generar prompts</span><span class="shortcut-key">Ctrl + Enter</span></div>
            <div class="shortcut-row"><span>Modo inspiraci√≥n</span><span class="shortcut-key">Ctrl + I</span></div>
            <div class="shortcut-row"><span>Generar variaciones</span><span class="shortcut-key">Ctrl + V</span></div>
            <div class="shortcut-row"><span>Cambiar tema</span><span class="shortcut-key">Ctrl + D</span></div>
            <div class="shortcut-row"><span>Copiar primer prompt</span><span class="shortcut-key">Ctrl + C</span></div>
            <div class="shortcut-row"><span>Siguiente nivel</span><span class="shortcut-key">Ctrl + ‚Üë</span></div>
            <div class="shortcut-row"><span>Anterior nivel</span><span class="shortcut-key">Ctrl + ‚Üì</span></div>
            <div class="shortcut-row"><span>Cerrar modal</span><span class="shortcut-key">Escape</span></div>
            <div style="margin-top:20px; text-align:center;">
                <button class="btn btn-sm btn-secondary" onclick="hideShortcuts()">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="js/prompt-generator.js"></script>
    <script>
        // === GLOBALS ===
        const generator = new PromptGenerator();
        let currentLevel = 0;
        let lastGeneratedPrompts = [];
        let lastPromptResult = null;

        // === THEME ===
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            showToast(next === 'dark' ? 'üåô Modo oscuro' : '‚òÄÔ∏è Modo claro');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // === LEVEL SELECTOR ===
        function setLevel(level) {
            currentLevel = level;
            document.querySelectorAll('.level-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === level);
            });
            onSettingsChange();
        }

        // === COLLAPSIBLE ===
        function toggleCollapsible(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            content.classList.toggle('hidden');
        }

        // === TAB SWITCHING ===
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.textContent.toLowerCase().includes(tabName.substring(0, 4))) t.classList.add('active');
            });
            document.getElementById('tab-' + tabName).classList.add('active');

            if (tabName === 'history') loadHistory();
            if (tabName === 'stats') updateStats();
        }

        function togglePanel(panelId) {
            const map = { 'history-panel': 'history', 'stats-panel': 'stats' };
            switchTab(map[panelId] || panelId);
        }

        // === SETTINGS CHANGE ===
        function onSettingsChange() {
            const style = document.getElementById('personStyle').value;

            // Conflict detection
            const conflicts = generator.detectConflicts({
                person_style: style,
                hair_color: document.getElementById('hairColor').value,
                ethnicity: document.getElementById('ethnicity').value,
                location: document.getElementById('location').value,
                explicitness_level: currentLevel,
            });

            const warningEl = document.getElementById('conflictWarning');
            if (conflicts.length > 0) {
                warningEl.innerHTML = conflicts.map(c =>
                    `<div class="conflict-item ${c.severity}">‚ö†Ô∏è ${c.message}</div>`
                ).join('');
                warningEl.classList.add('visible');
            } else {
                warningEl.classList.remove('visible');
            }

            // Suggestions
            const suggestions = generator.getSuggestions(style);
            const sugPanel = document.getElementById('suggestionsPanel');
            const sugText = document.getElementById('suggestionsText');
            sugPanel.style.display = 'block';
            sugText.innerHTML = `<strong>Ambiente:</strong> ${suggestions.atmosphere}<br><strong>Colores recomendados:</strong> ${suggestions.hairColors.join(', ')}`;
        }

        // === GATHER OPTIONS ===
        function gatherOptions() {
            return {
                explicitness_level: currentLevel,
                person_style: document.getElementById('personStyle').value,
                breast_size: document.getElementById('breastSize').value,
                hair_style: document.getElementById('hairStyle').value,
                hair_color: document.getElementById('hairColor').value,
                eye_color: document.getElementById('eyeColor').value,
                ethnicity: document.getElementById('ethnicity').value,
                age: parseInt(document.getElementById('ageSlider').value),
                clothed: document.getElementById('clothed').checked,
                wet: document.getElementById('wet').checked,
                compact: document.getElementById('compactMode').checked,
                emphasis: document.getElementById('emphasisMode').checked,
                custom_options: {
                    facial_expression: document.getElementById('facialExpression').value,
                    camera_angle: document.getElementById('cameraAngle').value,
                    location: document.getElementById('location').value,
                    scenario: document.getElementById('scenario').value,
                    clothing: document.getElementById('clothing').value,
                },
            };
        }

        // === GENERATE ===
        function generatePrompts() {
            const count = parseInt(document.getElementById('batchCount').value);
            const opts = gatherOptions();
            const compact = opts.compact;
            const emphasis = opts.emphasis;
            delete opts.compact;
            delete opts.emphasis;

            const prompts = [];
            for (let i = 0; i < count; i++) {
                let result;
                if (emphasis) {
                    result = generator.generateWithEmphasis(opts);
                } else if (compact) {
                    result = generator.generateCompactPrompt(opts);
                } else {
                    result = generator.generatePrompt(opts);
                }
                prompts.push(result);
            }

            lastGeneratedPrompts = prompts;
            lastPromptResult = prompts[0];
            displayPrompts(prompts);
            saveToHistory(prompts);
            switchTab('results');

            // Animate button
            const btn = document.getElementById('generateBtn');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = '', 150);
        }

        function generateInspiration() {
            const count = parseInt(document.getElementById('batchCount').value);
            const prompts = [];
            for (let i = 0; i < count; i++) {
                prompts.push(generator.generateInspiration());
            }
            lastGeneratedPrompts = prompts;
            lastPromptResult = prompts[0];
            displayPrompts(prompts);
            saveToHistory(prompts);
            switchTab('results');
            showToast('üé∞ Inspiraci√≥n generada');
        }

        function generateVariations() {
            if (!lastPromptResult) {
                showToast('Genera un prompt primero');
                return;
            }
            const evolutions = generator.generateEvolutions(lastPromptResult, parseInt(document.getElementById('batchCount').value));
            lastGeneratedPrompts = evolutions;
            displayPrompts(evolutions);
            saveToHistory(evolutions);
            switchTab('results');
            showToast('üîÑ Variaciones generadas');
        }

        // === DISPLAY PROMPTS ===
        function displayPrompts(prompts) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            prompts.forEach((p, i) => {
                const tokens = generator.countTokens(p.positive_prompt);
                const tokenInfo = generator.getTokenWarning(tokens);
                const negTokens = generator.countTokens(p.negative_prompt);
                const negTokenInfo = generator.getTokenWarning(negTokens);

                const card = document.createElement('div');
                card.className = 'prompt-card';
                card.innerHTML = `
                    <div class="prompt-card-header">
                        <span class="prompt-number">Prompt #${i + 1}${p.compact ? ' (Compacto)' : ''}${p.hasEmphasis ? ' (Emphasis)' : ''}${p.isVariation ? ' (Variaci√≥n)' : ''}</span>
                        <span class="token-badge token-${tokenInfo.level}">${tokenInfo.message}</span>
                    </div>
                    <div class="prompt-card-body">
                        <div class="prompt-section">
                            <div class="prompt-section-label">Positive Prompt</div>
                            <div class="prompt-text" id="positive-${i}">${p.positive_prompt}</div>
                        </div>
                        <div class="prompt-section">
                            <div class="prompt-section-label">Negative Prompt <span class="token-badge token-${negTokenInfo.level}" style="font-size:0.65rem">${negTokens} tokens</span></div>
                            <div class="prompt-text negative-text" id="negative-${i}">${p.negative_prompt}</div>
                        </div>
                        <div class="prompt-settings">
                            <span class="setting-chip">Steps: ${p.steps}</span>
                            <span class="setting-chip">CFG: ${p.cfg}</span>
                            <span class="setting-chip">Sampler: ${p.sampler}</span>
                            <span class="setting-chip">${p.width}√ó${p.height}</span>
                            <span class="setting-chip">Clip: ${p.clip_skip}</span>
                        </div>
                    </div>
                    <div class="prompt-card-actions">
                        <button class="vote-btn vote-up" onclick="votePrompt(${i}, 'up')">üëç Me gusta</button>
                        <button class="vote-btn vote-down" onclick="votePrompt(${i}, 'down')">üëé No me gusta</button>
                        <button class="copy-btn" onclick="copyPrompt(${i}, 'positive')">üìã Copiar Positivo</button>
                        <button class="copy-btn" onclick="copyPrompt(${i}, 'negative')">üìã Copiar Negativo</button>
                        <button class="copy-btn" onclick="copyPrompt(${i}, 'both')">üìã Copiar Todo</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // === COPY ===
        function copyPrompt(index, type) {
            const prompt = lastGeneratedPrompts[index];
            if (!prompt) return;

            let text = '';
            if (type === 'positive') text = prompt.positive_prompt;
            else if (type === 'negative') text = prompt.negative_prompt;
            else text = `Positive: ${prompt.positive_prompt}\n\nNegative: ${prompt.negative_prompt}\n\nSteps: ${prompt.steps} | CFG: ${prompt.cfg} | Sampler: ${prompt.sampler} | Size: ${prompt.width}x${prompt.height}`;

            navigator.clipboard.writeText(text).then(() => {
                showToast('üìã Copiado al portapapeles');
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('üìã Copiado');
            });
        }

        // === VOTE ===
        function votePrompt(index, type) {
            const prompt = lastGeneratedPrompts[index];
            if (!prompt) return;
            generator.registerVote(prompt.positive_prompt, type);
            showToast(type === 'up' ? 'üëç Voto registrado' : 'üëé Voto registrado');
        }

        // === HISTORY ===
        function saveToHistory(prompts) {
            try {
                let history = JSON.parse(localStorage.getItem('promptHistory') || '[]');
                const entry = {
                    time: new Date().toLocaleString('es-ES'),
                    timestamp: Date.now(),
                    prompts: prompts.map(p => ({
                        positive: p.positive_prompt.substring(0, 200) + '...',
                        full: p.positive_prompt,
                    })),
                };
                history.unshift(entry);
                if (history.length > 30) history = history.slice(0, 30);
                localStorage.setItem('promptHistory', JSON.stringify(history));
            } catch(e) { console.warn('History save error:', e); }
        }

        function loadHistory() {
            const list = document.getElementById('historyList');
            try {
                const history = JSON.parse(localStorage.getItem('promptHistory') || '[]');
                if (history.length === 0) {
                    list.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:20px;">Sin historial a√∫n</div>';
                    return;
                }
                list.innerHTML = history.map((entry, i) =>
                    `<div class="history-item" onclick="copyHistoryItem(${i})">
                        <div class="history-time">${entry.time} (${entry.prompts.length} prompt${entry.prompts.length > 1 ? 's' : ''})</div>
                        ${entry.prompts[0].positive}
                    </div>`
                ).join('');
            } catch(e) {
                list.innerHTML = '<div style="color:var(--text-muted);">Error cargando historial</div>';
            }
        }

        function copyHistoryItem(index) {
            try {
                const history = JSON.parse(localStorage.getItem('promptHistory') || '[]');
                if (history[index] && history[index].prompts[0]) {
                    navigator.clipboard.writeText(history[index].prompts[0].full || history[index].prompts[0].positive);
                    showToast('üìã Copiado del historial');
                }
            } catch(e) {}
        }

        function clearHistory() {
            localStorage.removeItem('promptHistory');
            loadHistory();
            showToast('üóëÔ∏è Historial limpiado');
        }

        // === STATS ===
        function updateStats() {
            const stats = generator.getDetailedStats();
            const grid = document.getElementById('statGrid');
            grid.innerHTML = `
                <div class="stat-card"><div class="stat-value">${stats.totalVotes}</div><div class="stat-label">Votos totales</div></div>
                <div class="stat-card"><div class="stat-value">${stats.totalElements}</div><div class="stat-label">Elementos votados</div></div>
                <div class="stat-card"><div class="stat-value">${stats.preferences.length}</div><div class="stat-label">Preferencias</div></div>
                <div class="stat-card"><div class="stat-value">${stats.historyCount}</div><div class="stat-label">En historial</div></div>
            `;

            const prefs = document.getElementById('topPreferences');
            prefs.innerHTML = stats.preferences.slice(0, 10).map(p =>
                `<div class="pref-item"><span class="element">${p.element}</span><span class="score">+${p.score}</span></div>`
            ).join('') || '<div style="color:var(--text-muted);">A√∫n sin preferencias - vota prompts!</div>';

            const avoided = document.getElementById('topAvoided');
            avoided.innerHTML = stats.avoided.slice(0, 10).map(p =>
                `<div class="pref-item"><span class="element">${p.element}</span><span class="score negative">${p.score}</span></div>`
            ).join('') || '<div style="color:var(--text-muted);">Ning√∫n elemento evitado todav√≠a</div>';
        }

        // === EXPORT ===
        function exportAs(format) {
            if (lastGeneratedPrompts.length === 0) {
                showToast('Genera prompts primero');
                return;
            }

            let content = '';
            let filename = `prompts_${Date.now()}`;
            let mimeType = 'text/plain';

            switch(format) {
                case 'json':
                    content = generator.exportJSON(lastGeneratedPrompts);
                    filename += '.json';
                    mimeType = 'application/json';
                    break;
                case 'csv':
                    content = generator.exportCSV(lastGeneratedPrompts);
                    filename += '.csv';
                    mimeType = 'text/csv';
                    break;
                case 'txt':
                    content = generator.exportTXT(lastGeneratedPrompts);
                    filename += '.txt';
                    break;
                case 'a1111':
                    content = generator.exportA1111(lastGeneratedPrompts);
                    filename += '_a1111.txt';
                    break;
                case 'comfyui':
                    content = generator.exportComfyUI(lastGeneratedPrompts);
                    filename += '_comfyui.json';
                    mimeType = 'application/json';
                    break;
            }

            // Download file
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast(`üì¶ Exportado como ${format.toUpperCase()}`);
        }

        // === PRESETS ===
        function saveCurrentPreset() {
            const name = document.getElementById('presetName').value.trim();
            if (!name) { showToast('Escribe un nombre para el preset'); return; }

            const options = gatherOptions();
            options.level = currentLevel;
            generator.savePreset(name, options);
            document.getElementById('presetName').value = '';
            loadPresets();
            showToast(`üíæ Preset "${name}" guardado`);
        }

        function loadPresets() {
            const presets = generator.getPresets();
            const list = document.getElementById('presetList');
            const names = Object.keys(presets);

            if (names.length === 0) {
                list.innerHTML = '<div style="color:var(--text-muted); font-size:0.8rem; padding:5px;">Sin presets guardados</div>';
                return;
            }

            list.innerHTML = names.map(name =>
                `<div class="preset-item">
                    <span onclick="applyPreset('${name}')">${name}</span>
                    <span class="preset-delete" onclick="deletePreset('${name}')">‚úï</span>
                </div>`
            ).join('');
        }

        function applyPreset(name) {
            const preset = generator.loadPreset(name);
            if (!preset) return;

            if (preset.level !== undefined) setLevel(preset.level);
            if (preset.person_style) document.getElementById('personStyle').value = preset.person_style;
            if (preset.breast_size) document.getElementById('breastSize').value = preset.breast_size;
            if (preset.hair_style) document.getElementById('hairStyle').value = preset.hair_style;
            if (preset.hair_color) document.getElementById('hairColor').value = preset.hair_color;
            if (preset.eye_color) document.getElementById('eyeColor').value = preset.eye_color;
            if (preset.ethnicity) document.getElementById('ethnicity').value = preset.ethnicity;
            if (preset.age) document.getElementById('ageSlider').value = preset.age;
            if (preset.age) document.getElementById('ageValue').textContent = preset.age;
            if (preset.clothed !== undefined) document.getElementById('clothed').checked = preset.clothed;
            if (preset.wet !== undefined) document.getElementById('wet').checked = preset.wet;
            if (preset.custom_options) {
                if (preset.custom_options.facial_expression) document.getElementById('facialExpression').value = preset.custom_options.facial_expression;
                if (preset.custom_options.camera_angle) document.getElementById('cameraAngle').value = preset.custom_options.camera_angle;
                if (preset.custom_options.location) document.getElementById('location').value = preset.custom_options.location;
                if (preset.custom_options.scenario) document.getElementById('scenario').value = preset.custom_options.scenario;
                if (preset.custom_options.clothing) document.getElementById('clothing').value = preset.custom_options.clothing;
            }

            onSettingsChange();
            showToast(`üìÇ Preset "${name}" cargado`);
        }

        function deletePreset(name) {
            generator.deletePreset(name);
            loadPresets();
            showToast(`üóëÔ∏è Preset "${name}" eliminado`);
        }

        // === TOAST ===
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 2500);
        }

        // === SHORTCUTS MODAL ===
        function showShortcuts() {
            document.getElementById('shortcutsModal').classList.add('visible');
        }

        function hideShortcuts() {
            document.getElementById('shortcutsModal').classList.remove('visible');
        }

        // === KEYBOARD SHORTCUTS ===
        document.addEventListener('keydown', function(e) {
            // Escape
            if (e.key === 'Escape') {
                hideShortcuts();
                return;
            }

            if (!e.ctrlKey) return;

            switch(e.key) {
                case 'Enter':
                    e.preventDefault();
                    generatePrompts();
                    break;
                case 'i':
                case 'I':
                    e.preventDefault();
                    generateInspiration();
                    break;
                case 'v':
                case 'V':
                    // Only if not in text input
                    if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        generateVariations();
                    }
                    break;
                case 'd':
                case 'D':
                    e.preventDefault();
                    toggleTheme();
                    break;
                case 'c':
                case 'C':
                    if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                        if (lastGeneratedPrompts.length > 0) {
                            e.preventDefault();
                            copyPrompt(0, 'positive');
                        }
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (currentLevel < 5) setLevel(currentLevel + 1);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    if (currentLevel > 0) setLevel(currentLevel - 1);
                    break;
            }
        });

        // === INIT ===
        loadTheme();
        loadPresets();
        onSettingsChange();
    </script>
</body>
</html>
